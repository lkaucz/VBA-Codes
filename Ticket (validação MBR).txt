Sub BAIXAR_ZPURDOCS()
Dim NOME As String
Dim NOME2 As String
Dim WBNAME As String
Dim LROW2 As Double
Set SapGuiAuto = GetObject("SAPGUI")  'Get the SAP GUI Scripting object
Set SAPApp = SapGuiAuto.GetScriptingEngine 'Get the currently running SAP GUI
Set SAPCon = SAPApp.Children(0) 'Get the first system that is currently connected
Set session = SAPCon.Children(0) 'Get the first session (window) on that connection
Application.DisplayAlerts = False
WBNAME = ThisWorkbook.Name
'ABRIR ZPURDOCS
session.findById("wnd[0]").maximize
session.findById("wnd[0]/tbar[0]/okcd").Text = "/nzpur_docs"
session.findById("wnd[0]").sendVKey 0
session.findById("wnd[0]").maximize
session.findById("wnd[0]/usr/btn%_SO_EBELN_%_APP_%-VALU_PUSH").press
'COPIA E COLA AS PO'S
LROW2 = Workbooks(WBNAME).Worksheets("Formulário Embarque Internacion").Cells(Rows.Count, 2).End(xlUp).Row
Workbooks(WBNAME).Worksheets("Formulário Embarque Internacion").Range("B14:B" & LROW2).Copy
session.findById("wnd[1]/tbar[0]/btn[24]").press
session.findById("wnd[1]/tbar[0]/btn[8]").press
session.findById("wnd[0]/usr/btn%_SO_DOKST_%_APP_%-VALU_PUSH").press
'COLOCAR APENAS ACEITO
session.findById("wnd[1]/usr/tabsTAB_STRIP/tabpSIVA/ssubSCREEN_HEADER:SAPLALDB:3010/tblSAPLALDBSINGLE/ctxtRSCSEL_255-SLOW_I[1,0]").Text = "59"

'session.findById("wnd[0]/usr/btn%_SO_DOKST_%_APP_%-VALU_PUSH").press
'ESCOLHER O LAYOUT CERTO (DANDO FALSE EM TUDO MENOS LATEST VERSION ONLY)
session.findById("wnd[1]/tbar[0]/btn[8]").press
session.findById("wnd[0]/usr/chkP_ELIKZ").Selected = False
session.findById("wnd[0]/usr/chkP_ELIKZ").SetFocus
session.findById("wnd[0]").sendVKey 2
session.findById("wnd[0]/usr/chkC_EQUIP").Selected = False
session.findById("wnd[0]/usr/chkC_PO_LI").Selected = False
session.findById("wnd[0]/usr/chkC_PO_LI").SetFocus
session.findById("wnd[0]").sendVKey 2
session.findById("wnd[0]/usr/chkC_SDS").Selected = False
session.findById("wnd[0]/usr/chkC_SDS").SetFocus
session.findById("wnd[0]").sendVKey 2
session.findById("wnd[0]/usr/chkC_LTSVER").Selected = True
session.findById("wnd[0]/usr/chkC_DIR").Selected = False
session.findById("wnd[0]/usr/chkC_DIR").SetFocus
session.findById("wnd[0]").sendVKey 2
session.findById("wnd[0]/usr/chkC_WBS").Selected = False
session.findById("wnd[0]/usr/chkC_WBS").SetFocus
session.findById("wnd[0]").sendVKey 2
'PEDIR EXPORT
session.findById("wnd[0]/tbar[1]/btn[8]").press
session.findById("wnd[0]/mbar/menu[0]/menu[3]/menu[1]").Select
session.findById("wnd[1]/tbar[0]/btn[0]").press

session.findById("wnd[1]/usr/ctxtDY_PATH").Text = Environ("USERPROFILE") & "\Desktop"


'Nomeia o export
NOME = Replace("ZPURDOCS " & Date & ".XLSX", "/", ".")


session.findById("wnd[1]/usr/ctxtDY_FILENAME").Text = NOME
session.findById("wnd[1]/tbar[0]/btn[11]").press
Call MECHERZPUR(NOME)
Call CV04N
NOME2 = Replace("CV04N " & Date & ".XLSX", "/", ".")
Call MECHER_CV04N(NOME2)
Call MECHERZPUR2(NOME, NOME2, WBNAME, LROW2)
End Sub
Sub TESTE()
Dim NOME As String
Dim NOME2 As String
Dim WBNAME As String
WBNAME = ThisWorkbook.Name
NOME = Replace("ZPURDOCS " & Date & ".XLSX", "/", ".")
NOME2 = Replace("CV04N " & Date & ".XLSX", "/", ".")
Call MECHERZPUR2(NOME, NOME2, WBNAME)
End Sub
Sub MECHERZPUR(NOME As String)

MPRNAME = Environ("USERPROFILE") & "\Desktop" & "\" & NOME
    
Workbooks.Open Filename:=MPRNAME
MPRNAME = ActiveWorkbook.Name
Workbooks(MPRNAME).Activate
Workbooks(MPRNAME).Worksheets("sheet1").Range("a1").AutoFilter
    'Worksheets("sheet1").Range("$A$1:$Z$44135").AutoFilter Field:=5, Criteria1:="="
'Application.DisplayAlerts = True
LROWMPR = Workbooks(MPRNAME).Worksheets("sheet1").Cells(Rows.Count, 2).End(xlUp).Row
'call baixar CV04N

    Sheets.Add After:=Worksheets("sheet1")
    Workbooks(MPRNAME).Worksheets("sheet1").Range("E2:E" & LROWMPR).Copy Workbooks(MPRNAME).Worksheets("sheet2").Range("A1")
    Application.CutCopyMode = False
    Workbooks(MPRNAME).Worksheets("sheet2").Range("$A:$A").RemoveDuplicates Columns:=1, Header:= _
        xlNo
    LROWMPR2 = Workbooks(MPRNAME).Worksheets("sheet2").Cells(Rows.Count, 1).End(xlUp).Row
    Workbooks(MPRNAME).Worksheets("sheet2").Range("A1:A" & LROWMPR).Copy

End Sub
Sub CV04N()
Set SapGuiAuto = GetObject("SAPGUI")  'Get the SAP GUI Scripting object
Set SAPApp = SapGuiAuto.GetScriptingEngine 'Get the currently running SAP GUI
Set SAPCon = SAPApp.Children(0) 'Get the first system that is currently connected
Set session = SAPCon.Children(0) 'Get the first session (window) on that connection
Application.DisplayAlerts = False
session.findById("wnd[0]").maximize
session.findById("wnd[0]/tbar[0]/okcd").Text = "/NCV04N"
session.findById("wnd[0]").sendVKey 0
session.findById("wnd[0]/usr/tabsMAINSTRIP/tabpTAB1/ssubSUBSCRN:SAPLCV100:0401/subSCR_MAIN:SAPLCV100:0402/txtRESTRICT").Text = "30000"
session.findById("wnd[0]/usr/tabsMAINSTRIP/tabpTAB1/ssubSUBSCRN:SAPLCV100:0401/subSCR_MAIN:SAPLCV100:0402/btn%_STDOKNR_%_APP_%-VALU_PUSH").press
session.findById("wnd[1]/tbar[0]/btn[24]").press
session.findById("wnd[1]/tbar[0]/btn[8]").press
session.findById("wnd[0]/tbar[1]/btn[8]").press
session.findById("wnd[0]/tbar[1]/btn[32]").press
session.findById("wnd[1]/usr/tabsG_TS_ALV/tabpALV_M_R1/ssubSUB_CONFIGURATION:SAPLSALV_CUL_COLUMN_SELECTION:0620/cntlCONTAINER1_LAYO/shellcont/shell").currentCellRow = -1
session.findById("wnd[1]/usr/tabsG_TS_ALV/tabpALV_M_R1/ssubSUB_CONFIGURATION:SAPLSALV_CUL_COLUMN_SELECTION:0620/cntlCONTAINER1_LAYO/shellcont/shell").selectColumn "SELTEXT"
session.findById("wnd[1]/usr/tabsG_TS_ALV/tabpALV_M_R1/ssubSUB_CONFIGURATION:SAPLSALV_CUL_COLUMN_SELECTION:0620/cntlCONTAINER1_LAYO/shellcont/shell").pressColumnHeader "SELTEXT"
session.findById("wnd[1]/usr/tabsG_TS_ALV/tabpALV_M_R1/ssubSUB_CONFIGURATION:SAPLSALV_CUL_COLUMN_SELECTION:0620/cntlCONTAINER1_LAYO/shellcont/shell").currentCellRow = 84
session.findById("wnd[1]/usr/tabsG_TS_ALV/tabpALV_M_R1/ssubSUB_CONFIGURATION:SAPLSALV_CUL_COLUMN_SELECTION:0620/cntlCONTAINER1_LAYO/shellcont/shell").firstVisibleRow = 81
session.findById("wnd[1]/usr/tabsG_TS_ALV/tabpALV_M_R1/ssubSUB_CONFIGURATION:SAPLSALV_CUL_COLUMN_SELECTION:0620/cntlCONTAINER1_LAYO/shellcont/shell").selectedRows = "84"
session.findById("wnd[1]/usr/tabsG_TS_ALV/tabpALV_M_R1/ssubSUB_CONFIGURATION:SAPLSALV_CUL_COLUMN_SELECTION:0620/btnAPP_WL_SING").press
session.findById("wnd[1]/usr/tabsG_TS_ALV/tabpALV_M_R1/ssubSUB_CONFIGURATION:SAPLSALV_CUL_COLUMN_SELECTION:0620/cntlCONTAINER1_LAYO/shellcont/shell").currentCellRow = 82
session.findById("wnd[1]/usr/tabsG_TS_ALV/tabpALV_M_R1/ssubSUB_CONFIGURATION:SAPLSALV_CUL_COLUMN_SELECTION:0620/cntlCONTAINER1_LAYO/shellcont/shell").selectedRows = "82"
session.findById("wnd[1]/usr/tabsG_TS_ALV/tabpALV_M_R1/ssubSUB_CONFIGURATION:SAPLSALV_CUL_COLUMN_SELECTION:0620/btnAPP_WL_SING").press
session.findById("wnd[1]/tbar[0]/btn[0]").press
session.findById("wnd[0]/mbar/menu[0]/menu[1]/menu[1]").Select
session.findById("wnd[1]/tbar[0]/btn[0]").press

session.findById("wnd[1]/usr/ctxtDY_PATH").Text = Environ("USERPROFILE") & "\Desktop"


'Nomeia o export
NOME = Replace("CV04N " & Date & ".XLSX", "/", ".")


session.findById("wnd[1]/usr/ctxtDY_FILENAME").Text = NOME
session.findById("wnd[1]/tbar[0]/btn[11]").press
Application.DisplayAlerts = True
End Sub
Sub MECHER_CV04N(NOME2 As String)

MPRNAME = Environ("USERPROFILE") & "\Desktop" & "\" & NOME2
    
Workbooks.Open Filename:=MPRNAME
MPRNAME = ActiveWorkbook.Name
Workbooks(MPRNAME).Activate
Workbooks(MPRNAME).Worksheets("sheet1").Range("a1").AutoFilter
Workbooks(MPRNAME).Worksheets("Sheet1").AutoFilter.Sort.SortFields.Add2 Key:= _
        Range("C:C"), SortOn:=xlSortOnValues, Order:=xlDescending, DataOption _
        :=xlSortNormal
    With ActiveWorkbook.Worksheets("Sheet1").AutoFilter.Sort
        .Header = xlYes
        .MatchCase = False
        .Orientation = xlTopToBottom
        .SortMethod = xlPinYin
        .Apply
    End With
End Sub
Sub MECHERZPUR2(NOME As String, NOME2 As String, WBNAME As String, LROW As Double)
Dim Arr(1 To 50000, 1 To 2) As Variant
MPRNAME = Environ("USERPROFILE") & "\Desktop" & "\" & NOME
    
Workbooks.Open Filename:=MPRNAME

MPRNAME = ActiveWorkbook.Name
Workbooks(MPRNAME).Worksheets("sheet1").Columns("K:K").Insert Shift:=xlToRight
Workbooks(MPRNAME).Worksheets("sheet1").Columns("K:K").Insert Shift:=xlToRight
    Workbooks(MPRNAME).Worksheets("sheet1").Range("K1").FormulaR1C1 = "Accept code"
    Workbooks(MPRNAME).Worksheets("sheet1").Range("L1").FormulaR1C1 = "Info Type"
    LROWMPR = Workbooks(MPRNAME).Worksheets("sheet1").Cells(Rows.Count, 2).End(xlUp).Row
For I = 2 To LROWMPR
Arr(I - 1, 1) = Application.Index(Workbooks(NOME2).Worksheets("sheet1").Range("U:U"), Application.Match(Workbooks(MPRNAME).Worksheets("sheet1").Range("E" & I), Workbooks(NOME2).Worksheets("sheet1").Range("B:B"), 0))
Arr(I - 1, 2) = Application.Index(Workbooks(NOME2).Worksheets("sheet1").Range("V:V"), Application.Match(Workbooks(MPRNAME).Worksheets("sheet1").Range("E" & I), Workbooks(NOME2).Worksheets("sheet1").Range("B:B"), 0))
Next I
Workbooks(MPRNAME).Worksheets("sheet1").Range("K2:L" & LROWMPR) = Arr
Erase Arr
For I = 2 To LROWMPR
If Workbooks(MPRNAME).Worksheets("sheet1").Range("K" & I) = "Accepted with comments" Then

Arr(I - 1, 1) = "Accepted"
Else
Arr(I - 1, 1) = Workbooks(MPRNAME).Worksheets("sheet1").Range("J" & I)
End If

Next I
Workbooks(MPRNAME).Worksheets("sheet1").Range("J2:J" & LROWMPR) = Arr
Workbooks(MPRNAME).Worksheets("sheet1").Columns("N:N").Insert Shift:=xlToRight
Workbooks(MPRNAME).Worksheets("sheet1").Range("N1").FormulaR1C1 = "MRB?"
Erase Arr

For I = 2 To LROWMPR
If Workbooks(MPRNAME).Worksheets("sheet1").Range("L" & I) = "Manufacturing Record Book (MRB" Then
Arr(I - 1, 1) = "YES"
Else
Arr(I - 1, 1) = "NO"
End If

Next I
Workbooks(MPRNAME).Worksheets("sheet1").Range("N2:N" & LROWMPR) = Arr
Erase Arr
Workbooks(MPRNAME).Worksheets("sheet1").Columns("b:b").Insert Shift:=xlToRight
Workbooks(MPRNAME).Worksheets("sheet1").Range("b1").FormulaR1C1 = "Concat"
Workbooks(MPRNAME).Worksheets("sheet1").Range("b2:b" & LROWMPR).FormulaR1C1 = "=RC[1]&RC[2]"
'Workbooks(MPRNAME).Activate
Workbooks(MPRNAME).Worksheets("sheet1").Range("$A:$AG").AutoFilter Field:=11, Criteria1:="Accepted"
Workbooks(MPRNAME).Worksheets("sheet1").Range("$A$1:$AG$" & LROWMPR).AutoFilter Field:=15, Criteria1:="YES"
For I = 14 To LROW
Concat = Workbooks(WBNAME).Worksheets("Formulário Embarque Internacion").Range("b" & I) & Workbooks(WBNAME).Worksheets("Formulário Embarque Internacion").Range("C" & I)
Arr(I - 13, 2) = WorksheetFunction.CountIfs(Workbooks(MPRNAME).Worksheets("sheet1").Range("B:B"), _
Concat, _
Workbooks(MPRNAME).Worksheets("sheet1").Range("O:O"), "YES", Workbooks(MPRNAME).Worksheets("sheet1").Range("K:K"), "Accepted")
If Arr(I - 13, 2) > 0 Then
Arr(I - 13, 1) = "MRB APROVADO"
Else
Arr(I - 13, 1) = "SEM MRB APROVADO"
End If
Workbooks(WBNAME).Worksheets("Formulário Embarque Internacion").Range("R14:R" & LROW) = Arr

Next I
End Sub